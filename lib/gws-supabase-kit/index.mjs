import {createClient}from'@supabase/supabase-js';import {useState,useCallback}from'react';import {jsxs,jsx}from'react/jsx-runtime';/**
 * gws-supabase-kit v1.0.0
 * Google Workspace + Supabase + Gemini AI integration kit
 * https://github.com/bp848/gws-mcp-superbase
 * (c) 2026 bp848. See LICENSE for terms.
 */
var x=class{constructor(e,t){this.supabase=e;this.getTokenUrl=t;this.cachedToken=null;this.tokenExpiresAt=0;}async getAccessToken(){let e=Date.now();if(this.cachedToken&&e<this.tokenExpiresAt-6e4)return this.cachedToken;let{data:t}=await this.supabase.auth.getSession(),r=t.session?.access_token;if(!r)throw new Error("Not authenticated");let s=await fetch(this.getTokenUrl,{method:"GET",headers:{Authorization:`Bearer ${r}`}});if(!s.ok){let a=await s.json().catch(()=>({})),c=new Error(a?.error??"Failed to get Google token");throw c.code=a?.code,c.reauthenticate=a?.reauthenticate,c}let o=await s.json();return this.cachedToken=o.access_token,this.tokenExpiresAt=e+o.expires_in*1e3,o.access_token}clearCache(){this.cachedToken=null,this.tokenExpiresAt=0;}};var L="https://www.googleapis.com/calendar/v3",S=class{constructor(e){this.getAccessToken=e;}async fetch(e,t){let r=await this.getAccessToken(),s=await fetch(`${L}${e}`,{...t,headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",...t?.headers??{}}});if(!s.ok){let o=await s.json().catch(()=>({}));throw new Error(`Calendar API error ${s.status}: ${o?.error?.message??s.statusText}`)}return s.json()}async listEvents(e={}){let{calendarId:t="primary",timeMin:r=new Date().toISOString(),timeMax:s,maxResults:o=10,orderBy:a="startTime",singleEvents:c=true}=e,l=new URLSearchParams({timeMin:r,maxResults:String(o),orderBy:a,singleEvents:String(c)});return s&&l.set("timeMax",s),(await this.fetch(`/calendars/${encodeURIComponent(t)}/events?${l}`)).items??[]}async createEvent(e,t="primary"){return this.fetch(`/calendars/${encodeURIComponent(t)}/events`,{method:"POST",body:JSON.stringify(e)})}async updateEvent(e,t,r="primary"){return this.fetch(`/calendars/${encodeURIComponent(r)}/events/${e}`,{method:"PATCH",body:JSON.stringify(t)})}async deleteEvent(e,t="primary"){let r=await this.getAccessToken(),s=await fetch(`${L}/calendars/${encodeURIComponent(t)}/events/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}});if(!s.ok&&s.status!==204)throw new Error(`Calendar delete error ${s.status}`)}async listCalendars(){return (await this.fetch("/users/me/calendarList")).items??[]}};var B="https://www.googleapis.com/gmail/v1/users/me",b=class{constructor(e){this.getAccessToken=e;}async fetch(e,t){let r=await this.getAccessToken(),s=await fetch(`${B}${e}`,{...t,headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",...t?.headers??{}}});if(!s.ok){let o=await s.json().catch(()=>({}));throw new Error(`Gmail API error ${s.status}: ${o?.error?.message??s.statusText}`)}return s.json()}async listMessages(e={}){let{maxResults:t=10,q:r,labelIds:s,pageToken:o}=e,a=new URLSearchParams({maxResults:String(t)});r&&a.set("q",r),o&&a.set("pageToken",o),s?.length&&s.forEach(g=>a.append("labelIds",g));let c=await this.fetch(`/messages?${a}`);return c.messages?.length?await Promise.all(c.messages.map(g=>this.getMessage(g.id))):[]}async getMessage(e){let t=await this.fetch(`/messages/${e}?format=full`),r=t.payload?.headers??[],s=g=>r.find(p=>p.name.toLowerCase()===g.toLowerCase())?.value,o="",l=(t.payload?.parts??[]).find(g=>g.mimeType==="text/plain")?.body?.data??t.payload?.body?.data;return l&&(o=atob(l.replace(/-/g,"+").replace(/_/g,"/"))),{id:t.id,threadId:t.threadId,subject:s("subject"),from:s("from"),to:s("to"),date:s("date"),snippet:t.snippet,body:o,labelIds:t.labelIds}}async sendMessage(e){let{to:t,subject:r,body:s,cc:o,bcc:a,isHtml:c=false}=e,l=c?"text/html":"text/plain",g=[`To: ${t}`,o?`Cc: ${o}`:"",a?`Bcc: ${a}`:"",`Subject: ${r}`,`Content-Type: ${l}; charset=utf-8`,"",s].filter(Boolean).join(`\r
`),p=btoa(unescape(encodeURIComponent(g))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");await this.fetch("/messages/send",{method:"POST",body:JSON.stringify({raw:p})});}async listThreads(e={}){let{maxResults:t=10,q:r}=e,s=new URLSearchParams({maxResults:String(t)});return r&&s.set("q",r),(await this.fetch(`/threads?${s}`)).threads??[]}};var G="https://www.googleapis.com/drive/v3",k=class{constructor(e){this.getAccessToken=e;}async fetch(e,t){let r=await this.getAccessToken(),s=await fetch(`${G}${e}`,{...t,headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",...t?.headers??{}}});if(!s.ok){let o=await s.json().catch(()=>({}));throw new Error(`Drive API error ${s.status}: ${o?.error?.message??s.statusText}`)}return s.json()}async listFiles(e={}){let{maxResults:t=20,q:r,orderBy:s="modifiedTime desc",fields:o="files(id,name,mimeType,modifiedTime,size,webViewLink,iconLink,parents)",pageToken:a}=e,c=new URLSearchParams({pageSize:String(t),orderBy:s,fields:`nextPageToken,${o}`});return r&&c.set("q",r),a&&c.set("pageToken",a),(await this.fetch(`/files?${c}`)).files??[]}async searchFiles(e,t={}){return this.listFiles({...t,q:`name contains '${e.replace(/'/g,"\\'")}' and trashed = false`})}async getFileContent(e){let t=await this.getAccessToken(),r=await fetch(`${G}/files/${e}/export?mimeType=text/plain`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok){let s=await fetch(`${G}/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)throw new Error(`Drive download error ${s.status}`);return s.text()}return r.text()}async getFile(e){return this.fetch(`/files/${e}?fields=id,name,mimeType,modifiedTime,size,webViewLink,iconLink,parents`)}async listFolders(e){let t=e?`mimeType = 'application/vnd.google-apps.folder' and '${e}' in parents and trashed = false`:"mimeType = 'application/vnd.google-apps.folder' and trashed = false";return this.listFiles({q:t})}};var T=class{constructor(e){this.proxyUrl=e;}async chat(e,t={}){let{model:r="gemini-2.0-flash",...s}=t,o=await fetch(this.proxyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,contents:e,config:s})});if(!o.ok){let l=await o.json().catch(()=>({}));throw new Error(`Gemini proxy error ${o.status}: ${l?.error??o.statusText}`)}let a=await o.json();return {text:a?.candidates?.[0]?.content?.parts?.map(l=>l.text??"").join("")??"",candidates:a?.candidates}}async complete(e,t={}){return (await this.chat([{role:"user",parts:[{text:e}]}],t)).text}createConversation(e={}){let t=[],r=this.chat.bind(this);return {async send(s){t.push({role:"user",parts:[{text:s}]});let o=await r(t,e);return t.push({role:"model",parts:[{text:o.text}]}),o.text},getHistory:()=>[...t],clearHistory:()=>t.splice(0)}}};var F=["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/gmail.send","https://www.googleapis.com/auth/drive.readonly"];function M(){let i=new Uint8Array(32);return crypto.getRandomValues(i),btoa(String.fromCharCode(...i)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async function O(i){let t=new TextEncoder().encode(i),r=await crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function z({supabase:i,config:e,exchangeCodeUrl:t,onSuccess:r,onError:s}){let[o,a]=useState({isConnected:false,isLoading:false,error:null}),c=useCallback(async()=>{a(p=>({...p,isLoading:true,error:null}));try{let p=e.scopes??F,n=e.usePKCE??!0,m={client_id:e.clientId,redirect_uri:e.redirectUri,response_type:"code",scope:p.join(" "),access_type:"offline",prompt:"consent"};if(n){let h=M(),f=await O(h);sessionStorage.setItem("gws_code_verifier",h),m.code_challenge=f,m.code_challenge_method="S256";}let d="https://accounts.google.com/o/oauth2/v2/auth?"+new URLSearchParams(m).toString();window.location.href=d;}catch(p){let n=p instanceof Error?p.message:"OAuth start failed";a(m=>({...m,isLoading:false,error:n})),s?.(n);}},[e,s]),l=useCallback(async p=>{a(n=>({...n,isLoading:true,error:null}));try{let{data:n}=await i.auth.getSession(),m=n.session?.access_token;if(!m)throw new Error("Not authenticated with Supabase");let d=sessionStorage.getItem("gws_code_verifier");sessionStorage.removeItem("gws_code_verifier");let h={code:p,redirect_uri:e.redirectUri};d&&(h.code_verifier=d);let f=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify(h)}),y=await f.json();if(!f.ok)throw new Error(y.error??"Token exchange failed");a({isConnected:!0,isLoading:!1,error:null}),r?.();}catch(n){let m=n instanceof Error?n.message:"Token exchange failed";a(d=>({...d,isLoading:false,error:m})),s?.(m);}},[i,e.redirectUri,t,r,s]),g=useCallback(async()=>{a({isConnected:false,isLoading:false,error:null});},[]);return {...o,startOAuth:c,handleCallback:l,disconnect:g}}function q(){let i=new Uint8Array(32);return crypto.getRandomValues(i),btoa(String.fromCharCode(...i)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async function N(i){let e=new TextEncoder().encode(i),t=await crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function H(){return jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z",fill:"#4285F4"}),jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z",fill:"#34A853"}),jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z",fill:"#FBBC05"}),jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z",fill:"#EA4335"})]})}function V({size:i=20}){return jsxs("svg",{width:i,height:i,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{animation:"gws-spin 0.8s linear infinite"},"aria-hidden":"true",children:[jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"3",strokeOpacity:"0.25"}),jsx("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round"}),jsx("style",{children:`
        @keyframes gws-spin {
          from { transform: rotate(0deg); }
          to   { transform: rotate(360deg); }
        }
      `})]})}function J({supabase:i,config:e,exchangeCodeUrl:t,label:r="Google \u3067\u30ED\u30B0\u30A4\u30F3",connectedLabel:s="Google \u9023\u643A\u6E08\u307F",defaultConnected:o=false,onSuccess:a,onError:c,style:l,className:g,variant:p="default"}){let[n,m]=useState(o),[d,h]=useState(false),[f,y]=useState(null),P=useCallback(async()=>{if(!(n||d)){h(true),y(null);try{let A=e.scopes??["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/gmail.readonly","https://www.googleapis.com/auth/gmail.send","https://www.googleapis.com/auth/drive.readonly"],w={client_id:e.clientId,redirect_uri:e.redirectUri,response_type:"code",scope:A.join(" "),access_type:"offline",prompt:"consent"};if(e.usePKCE!==!1){let _=q(),j=await N(_);sessionStorage.setItem("gws_code_verifier",_),w.code_challenge=j,w.code_challenge_method="S256";}window.location.href="https://accounts.google.com/o/oauth2/v2/auth?"+new URLSearchParams(w).toString();}catch(A){let w=A instanceof Error?A.message:"OAuth start failed";y(w),h(false),c?.(w);}}},[n,d,e,c]),R={...{display:"inline-flex",alignItems:"center",justifyContent:"center",gap:"10px",padding:"10px 20px",borderRadius:"8px",fontSize:"15px",fontWeight:500,fontFamily:"inherit",cursor:n?"default":d?"wait":"pointer",transition:"all 0.15s ease",border:"none",outline:"none",userSelect:"none",whiteSpace:"nowrap"},...{default:{background:n?"#e8f5e9":"#fff",color:n?"#2e7d32":"#3c4043",boxShadow:n?"none":"0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08)",border:"1px solid #dadce0"},outline:{background:"transparent",color:n?"#2e7d32":"#1a73e8",border:n?"2px solid #4caf50":"2px solid #1a73e8"},minimal:{background:"transparent",color:n?"#2e7d32":"#5f6368",padding:"8px 12px"}}[p],...l};return jsxs("div",{style:{display:"inline-flex",flexDirection:"column",gap:"6px"},children:[jsxs("button",{type:"button",onClick:P,disabled:n||d,style:R,className:g,"aria-label":n?s:r,"aria-busy":d,children:[d?jsx(V,{size:20}):n?jsx(K,{}):jsx(H,{}),jsx("span",{children:n?s:r})]}),f&&jsxs("p",{style:{margin:0,fontSize:"12px",color:"#d93025",display:"flex",alignItems:"center",gap:"4px"},role:"alert",children:["\u26A0 ",f]})]})}function K(){return jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[jsx("circle",{cx:"12",cy:"12",r:"10",fill:"#4caf50"}),jsx("path",{d:"M7 12.5l3.5 3.5 6.5-7",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}function W({supabase:i,exchangeCodeUrl:e,redirectUri:t,onSuccess:r,onError:s}){let[o,a]=useState(false),[c,l]=useState(null),[g,p]=useState(false);return {handleCode:useCallback(async m=>{a(true),l(null);try{let{data:d}=await i.auth.getSession(),h=d.session?.access_token;if(!h)throw new Error("Supabase \u30BB\u30C3\u30B7\u30E7\u30F3\u304C\u3042\u308A\u307E\u305B\u3093");let f=sessionStorage.getItem("gws_code_verifier");sessionStorage.removeItem("gws_code_verifier");let y={code:m,redirect_uri:t};f&&(y.code_verifier=f);let P=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify(y)}),$=await P.json();if(!P.ok)throw new Error($.error??"Token exchange failed");p(!0),r?.();}catch(d){let h=d instanceof Error?d.message:"\u8A8D\u8A3C\u306B\u5931\u6557\u3057\u307E\u3057\u305F";l(h),s?.(h);}finally{a(false);}},[i,e,t,r,s]),isLoading:o,error:c,isComplete:g}}var I=class{constructor(e){let{supabaseUrl:t,supabaseAnonKey:r,edgeFunctionBaseUrl:s}=e;this.supabase=createClient(t,r),this.baseUrl=s??`${t}/functions/v1`;let o=`${this.baseUrl}/get-google-token`;this.token=new x(this.supabase,o);let a=()=>this.token.getAccessToken();this.calendar=new S(a),this.gmail=new b(a),this.drive=new k(a),this.gemini=new T(`${this.baseUrl}/gemini-proxy`);}get exchangeCodeUrl(){return `${this.baseUrl}/exchange-google-code`}};
export{T as GeminiService,S as GoogleCalendarService,k as GoogleDriveService,b as GoogleGmailService,J as GoogleLoginButton,x as GoogleTokenService,I as GwsKit,z as useGoogleAuth,W as useGoogleAuthCallback};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map